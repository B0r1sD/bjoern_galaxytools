<tool id="blobtoolkit" name="BlobToolKit" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>genome assembly QC</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro='requirements' />
    <command detect_errors="exit_code"><![CDATA[
        #if $mode_conditional.selector == 'create'
            mkdir -p './Blobdir' &&
            mkdir -p './taxdump' &&
            ln -s '${mode_conditional.taxdump}' 'taxdump.tar' &&
            tar -xf 'taxdump.tar' -C './taxdump' &&
            ln -s '${mode_conditional.fasta}' 'assembly.fasta' &&
            #if $mode_conditional.meta
                ln -s '${mode_conditional.meta}' 'assembly.yaml' &&
            #end if
            blobtools create
            --fasta 'assembly.fasta'
            #if $mode_conditional.meta
                --meta 'assembly.yaml'
            #end if
            --taxid $mode_conditional.taxid
            --taxdump './taxdump'
            './Blobdir'
            && cp -r './taxdump' './Blobdir/'
            && tar -zcf './Blobdir.tgz' './Blobdir'

        #else if $mode_conditional.selector == 'add'
            tar -zxf '${mode_conditional.blobdir}' -C './' &&
            #if $mode_conditional.busco
                ln -s '${mode_conditional.busco}' './busco_results.tab' && 
            #end if
            #if $mode_conditional.blast_input.selector == 'enabled'
                ln -s '$mode_conditional.blast_input.hits' './blast_results.tab' &&
            #end if
            #if $mode_conditional.cov
                ln -s '$mode_conditional.cov' './input.bam' &&
                ln -s '$mode_conditional.cov.metadata.bam_index' './input.bam.bai' &&
            #end if
            #if $mode_conditional.bed
                    mkdir -p './bed_files' &&
                    #import re
                    #for $i, $input in enumerate($mode_conditional.bed):
                        #set $safename = re.sub('[^\w\-_]', '_', $input.element_identifier) + "." + str($i)
                        ln -sf '${input}' './bed_files/${safename}.bed' &&
                    #end for
            #end if
            blobtools add
                --threads \${GALAXY_SLOTS:-8}
                --taxdump './Blobdir/taxdump'
                #if $mode_conditional.busco
                    --busco './busco_results.tab'
                #end if
                #if $mode_conditional.blast_input.selector == 'enabled'
                    --hits './blast_results.tab'
                    #if $mode_conditional.blast_input.hits_cols
                        --hits-cols '${$mode_conditional.blast_input.hits_cols}'
                    #end if
                    --taxrule $mode_conditional.blast_input.taxrule
                    --evalue $mode_conditional.blast_input.evalue
                    --hit-count $mode_conditional.blast_input.hit_count
                    --bitscore $mode_conditional.blast_input.bitscore
                #end if
                #if $mode_conditional.bed
                    --beddir './bed_files'
                #end if
                #if $mode_conditional.cov
                    --cov './input.bam'
                #end if
                #if $mode_conditional.fasta
                    --fasta '${mode_conditional.fasta}'
                #end if
                #if $mode_conditional.trnascan
                    --trnascan '${mode_conditional.trnascan}'
                #end if
                #if $mode_conditional.text_input.selector == 'enabled'
                    --text '${mode_conditional.text_input.text}'
                    --text-cols '${mode_conditional.text_input.text_cols}'
                    $mode_conditional.text_input.text_header
                    $mode_conditional.text_input.text_no_array
                    --text-delimiter $mode_conditional.text_input.text_delimiter
                #end if
                #if $mode_conditional.advanced_options.blobdb
                    --blobdb '${mode_conditional.advanced_options.blobdb}'
                #end if
                #if $mode_conditional.advanced_options.synonyms
                    --synonyms '${mode_conditional.advanced_options.synonyms}'
                #end if
                $mode_conditional.advanced_options.update_plot
                #if $mode_conditional.advanced_options.pileup_args
                    --pileup-args '${mode_conditional.advanced_options.pileup_args}'
                #end if
                $mode_conditional.advanced_options.replace
                './Blobdir'
            && tar -zcf './Blobdir.tgz' './Blobdir'

        #else if $mode_conditional.selector == 'filter'
            tar -zxf '${mode_conditional.blobdir}' -C './' &&
            blobtools filter
            #if $mode_conditional.param
                --param $mode_conditional.param
            #end if
            #if $mode_conditional.string
                --query-string $mode_conditional.string
            #end if
            #if $mode_conditional.json
                --json $mode_conditional.json
            #end if
            #if $mode_conditional.list
                --list $mode_conditional.list
            #end if
            $mode_conditional.invert

            #if $mode_conditional.output
                --output $mode_conditional.output
            #end if
            #if $mode_conditional.fasta
                --fasta $mode_conditional.fasta
            #end if
            #if $mode_conditional.fastq
                --fastq $mode_conditional.fastq
            #end if
            #if $mode_conditional.text
                --text $mode_conditional.text
            #end if
            #if $mode_conditional.suffix
                --suffix $mode_conditional.suffix
            #end if
            #if $mode_conditional.summary
                --summary $mode_conditional.summary
            #end if
            #if $mode_conditional.table
                --table $mode_conditional.table
            #end if
            --summary './summary.json'
            --table './tabular_filtered.tabular'
            ./Blobdir
            && tar -zcf './Blobdir.tgz' './Blobdir'

        #else if $mode_conditional.selector == 'plots'
            mkdir -p './Blobdir' &&
            tar -zxf '${mode_conditional.blobdir}' -C './Blobdir' &&
            blobtools view
            #if $mode_conditional.format
                --format $mode_conditional.format
            #end if
            #if $mode_conditional.interactive
                --interactive
            #end if
            #if $mode_conditional.out
                --out $mode_conditional.out
            #end if
            #if $mode_conditional.param
                --param $mode_conditional.param
            #end if
            #if $mode_conditional.ports
                --ports $mode_conditional.ports
            #end if
            #if $mode_conditional.prefix
                --prefix $mode_conditional.prefix
            #end if
            #if $mode_conditional.preview
                --preview $mode_conditional.preview
            #end if
            #if $mode_conditional.driver
                --driver $mode_conditional.driver
            #end if
            #if $mode_conditional.driverlog
                --driverlog $mode_conditional.driverlog
            #end if
            #if $mode_conditional.local
                --local
            #end if
            #if $mode_conditional.remote
                --remote
            #end if
            #if $mode_conditional.timeout
                --timeout $mode_conditional.timeout
            #end if
            #if $mode_conditional.view
                --view $mode_conditional.view
            #end if
            #if $mode_conditional.host
                --host $mode_conditional.host
            #end if
        #end if
    ]]></command>
    <inputs>
        <conditional name="mode_conditional">
            <param name="selector" type="select" label="Select mode" help="Select a BlobToolKit module">
                <option value="create">Create a BlobToolKit dataset</option>
                <option value="add">Add data to a BlobToolKit dataset</option>
                <option value="filter">Filter a BlobToolKit dataset</option>
                <option value="plots">Generate plots</option>
            </param>
            <when value="create">
                <param argument="--fasta" type="data" format="fasta" label="Genome assembly file" help="FASTA sequence file" />
                <param argument="--meta" type="data" format="yaml" label="Metadata file" optional="true" help="Optional metadata dataset"/>
                <param argument="--taxid" type="integer" value="" label="NCBI taxonomy ID" help="Add ranks to metadata for a taxid"/>
                <param argument="--taxdump" type="data" format="tar,tgz,gz" label="NCBI taxdump directory" help="It should be compressed in tar.gz format"/>
            </when>
            <when value="add">
                <param name="blobdir" type="data" format="tgz" label="Blobdir.tgz file" help="This file should be generated by Blobtool create" />
                <param argument="--busco" type="data" format="tsv,tabular,txt" optional="true" label="BUSCO full table file"/>
                <conditional name="blast_input">
                    <param name="selector" type="select" label="BLAST/Diamond hits">
                        <option value="enabled">Enabled</option>
                        <option value="disabled" selected="true">Disabled</option>
                    </param>
                    <when value="enabled">
                        <param argument="--hits" type="data" format="tsv,tabular" optional="true" label="BLAST/Diamond hits dataset" help="Tabular BLAST/Diamond output file"/>
                        <param argument="--taxrule" type="select" label="BLAST hits to taxa rule" help="Rule to use when assigning BLAST hits to taxa">
                            <option value="bestsum">Bestsum</option>
                            <option value="bestsumorder">Bestsumorder</option>
                            <option value="bestdistsum">Bestdistsum</option>
                            <option value="bestdistsumorder">Bestdistsumorder</option>
                            <option value="blastp">Blastp</option>
                        </param>              
                        <param argument="--evalue" type="float" min="0" value="1" label="E-value cutoff"
                            help="The smaller the E-value, the better the match. Any hits with an evalue weaker than the value specified will be excluded"/>
                        <param argument="--bitscore" type="float" min="0" value="1" label="Bitscore cutoff" 
                            help="The higher the bit-score, the better the sequence similarity. Any hits with an bitscore lower the value specified will be excluded"/>
                        <param argument="--hit-count" type="integer" min="1" value="10" label="Hits to a given taxon" optional="true" 
                            help="By default the 10 highest scoring hits to a given taxon will be used when applying the --taxrule"/>
                        <param argument="--hits-cols" type="text" value="1=qseqid,2=staxids,3=bitscore,5=sseqid,10=qstart,11=qend,14=evalue" optional="true" 
                            label="BLAST/Diamond file column order" help="More information in the help section">
                            <sanitizer invalid_char="">
                                <valid initial="string.letters,string.digits">
                                    <add value="=" />
                                    <add value="," />
                                </valid>
                            </sanitizer>
                            <validator type="regex">[0-9a-z=,]+</validator>
                        </param>
                    </when>
                    <when value="disabled"/>
                </conditional>
                <param argument="--bed" type="data" format="bed" multiple="true" optional="true" label="BED file of coverages per scaffold"/>
                <param argument="--cov" type="data" format="bam,sam,cram" optional="true" label="BAM/SAM/CRAM read alignment file"/>
                <param argument="--fasta" type="data" format="fasta" optional="true" label="FASTA sequence" help="FASTA sequence file" />
                <param argument="--trnascan" type="data" format="tsv,tabular" optional="true" label="tRNAscan2-SE" help="tRNAscan-SE is employed for identifying and annotating tRNA genes in genomes"/>
                <expand macro="macro_text_input">
                    <param argument="--text-no-array" type="boolean" truevalue="--text-no-array" falsevalue="" checked="false" label="Prevent duplicated identifiers" 
                        help="Prevent fields in files with duplicate identifiers being loaded as array fields" />
                </expand>
                <section name="advanced_options" title="Advanced options">
                    <param argument="--blobdb" type="data" format="json" optional="true" label="Blobtools v1 database" help="This file should have been generated with the previous Blobtools tool version"/>
                    <param argument="--synonyms" type="data" format="tsv" optional="true" label="Identifier and sinonyms" help="TSV file containing current identifiers and synonyms"/>
                    <param argument="--update-plot" type="boolean" truevalue="--update-plot" falsevalue="" checked="false" label="Update plot" help="Flag to use new taxrule as default category" />
                    <param argument="--pileup-args" type="text" value="" optional="true" label="Samtools Pileup" help="Key/value pairs to pass to samtools pileup">
                        <sanitizer invalid_char="">
                            <valid initial="string.letters,string.digits">
                                <add value="=" />
                                <add value="," />
                                <add value="-" />
                            </valid>
                        </sanitizer>
                        <validator type="regex">[0-9a-zA-Z=,-]+</validator>
                    </param>
                    <param argument="--replace" type="boolean" truevalue="--replace" falsevalue="" checked="false" label="Replace fields" help="Allow existing fields to be overwritten" />
                </section>
            </when>
            <when value="filter">
                <param name="blobdir" type="data" format="tgz" label="Blobdir file" help="This file should be generated by the moudule create" />
                <param argument="--param" type="text" value="" optional="true" label="Parameter value" help="String of type param=value. Individual param=value pairs can be specified to 
                    filter based on Variable or Category fields">
                    <sanitizer invalid_char="">
                        <valid initial="string.letters,string.digits">
                            <add value="=" />
                            <add value="," />
                            <add value="-" />
                        </valid>
                    </sanitizer>
                    <validator type="regex">[0-9a-zA-Z=,-]+</validator>
                </param>
                <param argument="--list" type="text" value="" optional="true" label="List of identifiers" help="Space separated list of identifiers">
                    <sanitizer invalid_char="">
                        <valid initial="string.letters,string.digits">
                            <add value=" " />
                            <add value="-" />
                            <add value="_" />
                        </valid>
                    </sanitizer>
                    <validator type="regex">[0-9a-zA-Z _-]+</validator>
                </param>
                <param argument="--fasta" type="data" format="fasta" multiple="true" label="Assembly to be filtered" help="FASTA format assembly file to be filtered"/>
                <param argument="--fastq" type="data" format="fastq" optional="true" label="Reads to be filtered" help="FASTQ format read file to be filtered (requires --cov)"/>
                <param argument="--cov" type="data" format="bam,sam,cram" optional="true" label="BAM/SAM/CRAM read alignment file" />
                <expand macro="macro_text_input"/>
                <param argument="--summary-rank" type="text" value="phylum" label="Sumamry rank" help="Taxonomic level for summary">
                    <sanitizer invalid_char="">
                        <valid initial="string.letters"/>
                    </sanitizer>
                    <validator type="regex">[a-zA-Z]+</validator>
                </param>
                <param argument="--invert" type="boolean" truevalue="--invert" falsevalue="" checked="false" label="Invert filter" help="Invert the filter (exclude matching records)"/>
            </when>
            <when value="plots">
                <param argument="--format" type="text" optional="true" label="Image format" help="Image format (svg|png). [Default: png]"/>
                <param argument="--out" type="text" optional="true" default_value=" ." label="Outfiles" help="Directory for outfiles. [Default: .]"/>
                <param argument="--param" type="text" optional="true" label="Query parameter" help="Query string parameter."/>
                <param argument="--prefix" type="text" optional="true" label="URL prefix" help="URL prefix. [Default: view]"/>
                <param argument="--preview" type="text" optional="true" label="Field name" help="Field name"/>
                <param argument="--local" type="boolean" optional="true" label="Local session" help="Start viewer for local session. [Default: False]"/>
                <param argument="--view" type="text" optional="true" label="Plot Type" help="Plot type (blob|cumulative|snail). [Default: blob]"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="blobdir_create" format="tgz" from_work_dir="./Blobdir.tgz" label="${tool.name} on ${on_string}: Blobdir.tgz">
            <filter>mode_conditional['selector'] == 'create'</filter>
        </data>
        <data name="blobdir_add" format="tgz" from_work_dir="./Blobdir.tgz" label="${tool.name} on ${on_string}: Blobdir.tgz">
            <filter>mode_conditional['selector'] == 'add'</filter>
        </data>
        <data name="blobdir_update" format="tgz" from_work_dir="./Blobdir.tgz" label="${tool.name} on ${on_string}: Blobdir.tgz">
            <filter>mode_conditional['selector'] == 'update'</filter>
        </data>
        <data name="blobdir_filter" format="tgz" from_work_dir="./Blobdir.tgz" label="${tool.name} on ${on_string}: Blobdir.tgz">
            <filter>mode_conditional['selector'] == 'filter'</filter>
        </data>
        <data name="blobdir_plots" format="tgz" from_work_dir="./Blobdir.tgz" label="${tool.name} on ${on_string}: Blobdir.tgz">
            <filter>mode_conditional['selector'] == 'plots'</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="fasta" value="assembly.fasta"/>
            <param name="meta" value="assembly.yaml"/>
            <param name="taxid" value=""/>
            <param name="taxdump" value="taxdump.tar.gz"/>
            <!--output name="identifiers" file="identifiers.json"/-->
            <output name="blobdir_create" file="length.json, gc.json, identifiers.json, meta.json, ncount.json"/>
        </test>
    </tests>
    <help><![CDATA[
    BlobToolKit is a software suite to aid researchers in identifying and isolating non-target data in draft and publicly available genome assemblies. It can be used to process assembly, 
    read and analysis files for fully reproducible interactive exploration in the browser-based Viewer. BlobToolKit can be used during assembly to filter non-target DNA, helping researchers produce assemblies with high biological credibility.
    ]]></help>
    <expand macro="citations"/>
</tool>